<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å°æœ‹å‹æ‰“å­—æ¸¸æˆï¼ˆå…³å¡ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#f4fbff;
      --card:#ffffff;
      --ink:#203040;
      --accent:#2bbbad;
      --ok:#2e7d32;
      --warn:#ef6c00;
      --bad:#d32f2f;
      --shadow:0 8px 22px rgba(24,60,90,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      background:linear-gradient(180deg,#e8f7ff,#f7fcff);
      color:var(--ink);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:24px;
    }
    .app{ width:min(920px,100%); background:var(--card); border-radius:20px; box-shadow:var(--shadow); padding:24px; }
    h1{ margin:0 0 6px; color:#0f766e; font-size:28px; }
    .sub{margin:0 0 16px;color:#4f6b80}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn, select{
      border:2px solid #b6d9ee; background:#fff; color:#234; border-radius:12px;
      padding:9px 14px; font-size:15px; cursor:pointer;
    }
    .btn:hover{border-color:var(--accent)}
    .stats{ display:grid; grid-template-columns:repeat(4,minmax(120px,1fr)); gap:10px; margin:14px 0; }
    .stat{ background:#f2fbff; border:1px solid #d9eef7; border-radius:12px; padding:10px; text-align:center; }
    .stat .k{font-size:12px;color:#5f7c90}
    .stat .v{font-size:22px;font-weight:700;color:#0f5a66}
    .quote{
      background:#f9fcff; border:2px dashed #b6d9ee; border-radius:14px;
      padding:14px; font-size:28px; line-height:1.7; min-height:116px;
      letter-spacing:1px; user-select:none; word-break:break-word;
    }
    .ok{color:var(--ok)}
    .bad{color:var(--bad);text-decoration:underline}
    input[type="text"]{
      width:100%; margin-top:12px; font-size:24px; border:2px solid #b6d9ee;
      border-radius:12px; padding:12px; outline:none;
    }
    input[type="text"]:focus{border-color:#60c9d8}
    .tips{margin-top:10px;color:#557287;font-size:14px}
    .result{ margin-top:14px; padding:12px; border-radius:12px; background:#f3fff5; border:1px solid #c8efcf; display:none; }
    .link-home{display:inline-block;margin-top:12px;color:#116466;text-decoration:none}
    .pill{display:inline-block; padding:2px 10px; border-radius:999px; background:#e5f9f5; color:#0d6b60; font-size:13px; margin-left:8px;}
    @media (max-width:700px){
      .stats{grid-template-columns:repeat(2,minmax(120px,1fr))}
      .quote{font-size:22px}
      input[type="text"]{font-size:20px}
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>âŒ¨ï¸ æ‰“å­—é—¯å…³æ¸¸æˆ <span class="pill">ç›²æ‰“è®­ç»ƒ</span></h1>
    <p class="sub">å…³å¡ä¼šé€æ­¥å¢åŠ å­—æ¯èŒƒå›´å’Œéš¾åº¦ï¼šå…ˆä» <b>asdfghjkl</b> å…¥é—¨ï¼Œè¾¾åˆ°ç›®æ ‡åˆ†æ•°å³å¯è¿‡å…³ã€‚</p>

    <div class="row">
      <label>å…³å¡ï¼š
        <select id="levelSelect"></select>
      </label>
      <label>æ—¶é•¿ï¼š
        <select id="timeSelect">
          <option value="30">30ç§’</option>
          <option value="60" selected>60ç§’</option>
          <option value="90">90ç§’</option>
        </select>
      </label>
      <button class="btn" id="startBtn">å¼€å§‹é—¯å…³</button>
      <button class="btn" id="resetBtn">é‡ç½®</button>
    </div>

    <div class="stats">
      <div class="stat"><div class="k">å…³å¡</div><div class="v" id="levelName">L1</div></div>
      <div class="stat"><div class="k">å€’è®¡æ—¶</div><div class="v" id="time">60</div></div>
      <div class="stat"><div class="k">å½“å‰åˆ†æ•°</div><div class="v" id="score">0</div></div>
      <div class="stat"><div class="k">è¿‡å…³ç›®æ ‡</div><div class="v" id="targetScore">25</div></div>
    </div>

    <div class="stats">
      <div class="stat"><div class="k">é€Ÿåº¦ WPM</div><div class="v" id="wpm">0</div></div>
      <div class="stat"><div class="k">å‡†ç¡®ç‡</div><div class="v" id="acc">100%</div></div>
      <div class="stat"><div class="k">å®Œæˆè¯æ¡</div><div class="v" id="done">0</div></div>
      <div class="stat"><div class="k">æœ€é«˜è§£é”</div><div class="v" id="unlock">L1</div></div>
    </div>

    <div id="quote" class="quote"></div>
    <input id="input" type="text" placeholder="ç‚¹å‡»â€œå¼€å§‹é—¯å…³â€ååœ¨è¿™é‡Œè¾“å…¥â€¦" disabled />
    <div class="tips" id="tips">æç¤ºï¼šåªéœ€è¦æŒ‰ç›®æ ‡å­—ç¬¦è¾“å…¥ï¼Œå®Œæ•´è¾“å…¥ä¸€æ¡å°±å¾—åˆ†ã€‚è¾¾æ ‡ç«‹å³è¿‡å…³å¹¶è§£é”ä¸‹ä¸€å…³ã€‚</div>

    <div id="result" class="result"></div>
    <a class="link-home" href="index.html">â† è¿”å›é¦–é¡µ</a>
  </div>

  <script>
    const levels = [
      { name: 'L1 å…¥é—¨ï¼ˆä¸»æ’ï¼‰', chars: 'asdfghjkl', minLen: 4, maxLen: 6, passScore: 25 },
      { name: 'L2 æ‰©å±•ï¼ˆä¸Šæ’ï¼‰', chars: 'asdfghjklqwertyuiop', minLen: 5, maxLen: 7, passScore: 35 },
      { name: 'L3 å…¨å­—æ¯', chars: 'abcdefghijklmnopqrstuvwxyz', minLen: 6, maxLen: 9, passScore: 45 },
      { name: 'L4 æ··åˆå¼ºåŒ–', chars: 'abcdefghijklmnopqrstuvwxyz', minLen: 8, maxLen: 12, passScore: 60 }
    ];

    const quoteEl = document.getElementById('quote');
    const inputEl = document.getElementById('input');
    const timeEl = document.getElementById('time');
    const wpmEl = document.getElementById('wpm');
    const accEl = document.getElementById('acc');
    const doneEl = document.getElementById('done');
    const resultEl = document.getElementById('result');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const timeSelect = document.getElementById('timeSelect');
    const levelSelect = document.getElementById('levelSelect');
    const levelNameEl = document.getElementById('levelName');
    const scoreEl = document.getElementById('score');
    const targetScoreEl = document.getElementById('targetScore');
    const unlockEl = document.getElementById('unlock');
    const tipsEl = document.getElementById('tips');

    let timer = null;
    let totalTime = 60;
    let left = 60;
    let started = false;
    let finished = false;
    let done = 0;
    let totalTyped = 0;
    let totalCorrect = 0;
    let score = 0;
    let target = '';
    let currentLevel = 0;
    let unlockedLevel = Number(localStorage.getItem('typingUnlockedLevel') || 0);

    function randInt(a, b){ return Math.floor(Math.random() * (b - a + 1)) + a; }

    function generateTarget(){
      const lv = levels[currentLevel];
      const len = randInt(lv.minLen, lv.maxLen);
      let s = '';
      for (let i = 0; i < len; i++) s += lv.chars[randInt(0, lv.chars.length - 1)];
      return s;
    }

    function refreshLevelSelect(){
      levelSelect.innerHTML = levels.map((lv, i) => {
        const lock = i > unlockedLevel;
        return `<option value="${i}" ${lock ? 'disabled' : ''}>${lv.name}${lock ? 'ï¼ˆæœªè§£é”ï¼‰' : ''}</option>`;
      }).join('');
      if (currentLevel > unlockedLevel) currentLevel = unlockedLevel;
      levelSelect.value = String(currentLevel);
      unlockEl.textContent = `L${unlockedLevel + 1}`;
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    }

    function renderQuote() {
      const typed = inputEl.value;
      let html = '';
      for (let i = 0; i < target.length; i++) {
        const ch = target[i];
        if (i < typed.length) {
          html += typed[i] === ch ? `<span class="ok">${escapeHtml(ch)}</span>` : `<span class="bad">${escapeHtml(ch)}</span>`;
        } else {
          html += `<span>${escapeHtml(ch)}</span>`;
        }
      }
      quoteEl.innerHTML = html;
    }

    function calcStats() {
      const elapsedMin = Math.max((totalTime - left) / 60, 1/60);
      const wpm = Math.round((totalCorrect / 5) / elapsedMin);
      const acc = totalTyped ? Math.round((totalCorrect / totalTyped) * 100) : 100;
      wpmEl.textContent = isFinite(wpm) ? wpm : 0;
      accEl.textContent = `${acc}%`;
      doneEl.textContent = done;
      scoreEl.textContent = score;
    }

    function setLevelInfo(){
      const lv = levels[currentLevel];
      levelNameEl.textContent = `L${currentLevel + 1}`;
      targetScoreEl.textContent = lv.passScore;
      tipsEl.textContent = `å½“å‰å­—ç¬¦èŒƒå›´ï¼š${lv.chars} ï½œ è¾“å…¥å®Œæ•´è¯æ¡å¾—åˆ†ï¼š+${lv.minLen}~+${lv.maxLen}ï¼Œè¾¾åˆ° ${lv.passScore} åˆ†è¿‡å…³ã€‚`;
    }

    function nextTarget(){
      target = generateTarget();
      inputEl.value = '';
      renderQuote();
    }

    function passLevel(){
      if (timer) clearInterval(timer);
      started = false;
      finished = true;
      inputEl.disabled = true;
      const last = currentLevel === levels.length - 1;
      let msg = `ğŸ è¿‡å…³ï¼ä½ é€šè¿‡äº† <b>${levels[currentLevel].name}</b>ã€‚`;

      if (!last && unlockedLevel < currentLevel + 1) {
        unlockedLevel = currentLevel + 1;
        localStorage.setItem('typingUnlockedLevel', String(unlockedLevel));
        msg += `<br>ğŸ”“ å·²è§£é”ä¸‹ä¸€å…³ï¼š<b>${levels[unlockedLevel].name}</b>`;
      }
      if (last) msg += '<br>ğŸŒŸ ä½ å·²å®Œæˆå…¨éƒ¨å…³å¡ï¼Œå¤ªå¼ºäº†ï¼';
      msg += `<br>æˆç»©ï¼šåˆ†æ•° <b>${score}</b> / ç›®æ ‡ <b>${levels[currentLevel].passScore}</b>ï¼Œé€Ÿåº¦ <b>${wpmEl.textContent}</b> WPMï¼Œå‡†ç¡®ç‡ <b>${accEl.textContent}</b>ã€‚`;

      refreshLevelSelect();
      resultEl.style.display = 'block';
      resultEl.innerHTML = msg;
    }

    function startGame() {
      currentLevel = Number(levelSelect.value);
      const lv = levels[currentLevel];
      totalTime = Number(timeSelect.value);
      left = totalTime;
      started = true;
      finished = false;
      done = 0;
      totalTyped = 0;
      totalCorrect = 0;
      score = 0;
      resultEl.style.display = 'none';

      timeEl.textContent = left;
      setLevelInfo();
      calcStats();

      inputEl.disabled = false;
      inputEl.focus();
      nextTarget();

      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        left--;
        timeEl.textContent = left;
        calcStats();
        if (left <= 0) endGame();
      }, 1000);
    }

    function endGame() {
      if (timer) clearInterval(timer);
      finished = true;
      started = false;
      inputEl.disabled = true;
      calcStats();
      resultEl.style.display = 'block';
      const ok = score >= levels[currentLevel].passScore;
      resultEl.innerHTML = ok
        ? `ğŸ‰ æ—¶é—´åˆ°ï¼Œä½†ä½ å·²è¾¾æ ‡ï¼<br>åˆ†æ•° <b>${score}</b> / ç›®æ ‡ <b>${levels[currentLevel].passScore}</b>ï¼Œé€Ÿåº¦ <b>${wpmEl.textContent}</b> WPMï¼Œå‡†ç¡®ç‡ <b>${accEl.textContent}</b>ã€‚`
        : `â° æ—¶é—´åˆ°ï¼<br>åˆ†æ•° <b>${score}</b> / ç›®æ ‡ <b>${levels[currentLevel].passScore}</b>ï¼Œé€Ÿåº¦ <b>${wpmEl.textContent}</b> WPMï¼Œå‡†ç¡®ç‡ <b>${accEl.textContent}</b>ã€‚å†æ¥ä¸€æ¬¡å°±èƒ½è¿‡å…³ï¼`;
      if (ok) passLevel();
    }

    function resetGame() {
      if (timer) clearInterval(timer);
      totalTime = Number(timeSelect.value);
      left = totalTime;
      started = false;
      finished = false;
      done = 0;
      totalTyped = 0;
      totalCorrect = 0;
      score = 0;
      target = '';
      currentLevel = Math.min(Number(levelSelect.value || 0), unlockedLevel);
      timeEl.textContent = left;
      wpmEl.textContent = '0';
      accEl.textContent = '100%';
      doneEl.textContent = '0';
      scoreEl.textContent = '0';
      inputEl.value = '';
      inputEl.disabled = true;
      resultEl.style.display = 'none';
      setLevelInfo();
      quoteEl.textContent = 'ç‚¹å‡»â€œå¼€å§‹é—¯å…³â€å¼€å§‹å§ï¼';
    }

    inputEl.addEventListener('input', () => {
      if (!started || finished) return;

      const typed = inputEl.value;
      let nowCorrect = 0;
      const n = Math.min(typed.length, target.length);
      for (let i = 0; i < n; i++) if (typed[i] === target[i]) nowCorrect++;

      totalTyped++;
      const prevTyped = typed.slice(0, -1);
      let prevCorrect = 0;
      const m = Math.min(prevTyped.length, target.length);
      for (let i = 0; i < m; i++) if (prevTyped[i] === target[i]) prevCorrect++;
      totalCorrect += Math.max(0, nowCorrect - prevCorrect);

      renderQuote();
      calcStats();

      if (typed === target) {
        done++;
        score += target.length;
        calcStats();
        if (score >= levels[currentLevel].passScore) {
          passLevel();
          return;
        }
        nextTarget();
      }
    });

    startBtn.addEventListener('click', startGame);
    resetBtn.addEventListener('click', resetGame);
    levelSelect.addEventListener('change', () => {
      if (!started) {
        currentLevel = Number(levelSelect.value);
        setLevelInfo();
      }
    });
    timeSelect.addEventListener('change', () => {
      if (!started) {
        totalTime = Number(timeSelect.value);
        left = totalTime;
        timeEl.textContent = left;
      }
    });

    refreshLevelSelect();
    resetGame();
  </script>
</body>
</html>