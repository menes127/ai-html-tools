<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Typing Shooter - å­—æ¯å°„å‡»è®­ç»ƒ</title>
  <style>
    :root{--bg:#0b1020;--panel:#121a33;--ink:#e8efff;--sub:#9db0d8;--ok:#3ddc97;--warn:#ffb020;--bad:#ff5d7a;--line:#243157}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,"PingFang SC","Microsoft YaHei",sans-serif;background:radial-gradient(circle at 30% -10%,#1d2a56,#0b1020 55%);color:var(--ink);padding:16px}
    .app{max-width:1080px;margin:0 auto}
    .top{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .title{font-size:26px;font-weight:800}
    .title span{font-size:13px;color:#95f3ff;background:#17364b;border:1px solid #2d6b8b;padding:2px 8px;border-radius:999px;margin-left:8px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    select,button{background:#1a2547;color:#e9f0ff;border:1px solid #304070;border-radius:10px;padding:8px 12px}
    button{cursor:pointer}
    button:hover{filter:brightness(1.08)}
    .stats{display:grid;grid-template-columns:repeat(7,minmax(80px,1fr));gap:8px;margin-bottom:10px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:8px;text-align:center}
    .k{font-size:12px;color:var(--sub)} .v{font-size:20px;font-weight:700}
    #gameWrap{background:#091126;border:1px solid var(--line);border-radius:14px;padding:10px}
    canvas{width:100%;height:auto;display:block;background:linear-gradient(180deg,#091126,#0c1630)}
    .bottom{display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:10px;align-items:center}
    #typed{font-size:28px;letter-spacing:1px;background:#111a36;border:1px solid #2c3c70;border-radius:12px;padding:10px 14px;min-height:56px}
    #typed em{color:#7f92bf;font-style:normal}
    .hint{color:var(--sub);font-size:13px;margin-top:8px}
    #result{display:none;margin-top:10px;padding:10px;border-radius:10px;background:#12283a;border:1px solid #295274}
    a{color:#9fd4ff}
    @media (max-width:900px){.stats{grid-template-columns:repeat(3,minmax(80px,1fr))}.bottom{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="app">
  <div class="top">
    <div class="title">ğŸš€ Typing Shooter <span>ä»…è‹±æ–‡å­—æ¯</span></div>
    <div class="controls">
      <label>å…³å¡ <select id="level"></select></label>
      <label>æ—¶é•¿ <select id="time"><option>60</option><option selected>90</option><option>120</option></select>s</label>
      <button id="start">å¼€å§‹</button>
      <button id="reset">é‡ç½®</button>
    </div>
  </div>

  <div class="stats">
    <div class="card"><div class="k">å…³å¡</div><div class="v" id="sLevel">L1</div></div>
    <div class="card"><div class="k">ç›®æ ‡åˆ†</div><div class="v" id="sGoal">40</div></div>
    <div class="card"><div class="k">å¾—åˆ†</div><div class="v" id="sScore">0</div></div>
    <div class="card"><div class="k">è¿å‡»</div><div class="v" id="sCombo">0</div></div>
    <div class="card"><div class="k">ç”Ÿå‘½</div><div class="v" id="sLife">5</div></div>
    <div class="card"><div class="k">æ—¶é—´</div><div class="v" id="sTime">90</div></div>
    <div class="card"><div class="k">è§£é”</div><div class="v" id="sUnlock">L1</div></div>
  </div>

  <div id="gameWrap"><canvas id="cv" width="1000" height="520"></canvas></div>

  <div class="bottom">
    <div id="typed"><em>è¾“å…¥å­—æ¯ä»¥ç„å‡†ï¼šå®Œæ•´æ‰“å‡ºç›®æ ‡è¯ä¼šå‘å°„å¹¶å‡»ä¸­</em></div>
    <div><a href="index.html">â† è¿”å›é¦–é¡µ</a></div>
  </div>
  <div class="hint">ç©æ³•ï¼šå¤©ç©ºä¸­çš„ç›®æ ‡å¸¦æœ‰å­—æ¯ä¸²ï¼Œé”®ç›˜è¾“å…¥ï¼ˆa-zï¼‰åŒ¹é…å®Œæ•´è¯æ¡å³å¯å‡»ä¸­ã€‚Backspace å¯åˆ é™¤ï¼›è¾¾æ ‡åˆ†æ•°è‡ªåŠ¨è¿‡å…³å¹¶è§£é”ä¸‹ä¸€å…³ã€‚</div>
  <div id="result"></div>
</div>

<script>
const levels=[
  {name:'L1 å•å­—æ¯çƒ­èº«', chars:'asdfghjkl', min:1, max:1, goal:24, speed:30, spawn:1500},
  {name:'L2 åŒå­—æ¯å…¥é—¨', chars:'asdfghjkl', min:2, max:3, goal:45, speed:36, spawn:1300},
  {name:'L3 ä¸‰å››å­—æ¯è¿›é˜¶', chars:'asdfghjklqwertyuiop', min:3, max:4, goal:70, speed:42, spawn:1120},
  {name:'L4 å…¨é”®åŒºæŒ‘æˆ˜', chars:'abcdefghijklmnopqrstuvwxyz', min:4, max:6, goal:95, speed:48, spawn:980},
  {name:'L5 é«˜å‹å¼ºåŒ–', chars:'abcdefghijklmnopqrstuvwxyz', min:5, max:8, goal:125, speed:56, spawn:850}
];

const cv=document.getElementById('cv'),ctx=cv.getContext('2d');
const el={level:document.getElementById('level'),time:document.getElementById('time'),start:document.getElementById('start'),reset:document.getElementById('reset'),typed:document.getElementById('typed'),result:document.getElementById('result'),sLevel:document.getElementById('sLevel'),sGoal:document.getElementById('sGoal'),sScore:document.getElementById('sScore'),sCombo:document.getElementById('sCombo'),sLife:document.getElementById('sLife'),sTime:document.getElementById('sTime'),sUnlock:document.getElementById('sUnlock')};

let unlocked=+localStorage.getItem('typingShooterUnlocked')||0;
let state;

function setupLevelOptions(){
  el.level.innerHTML=levels.map((l,i)=>`<option value="${i}" ${i>unlocked?'disabled':''}>${l.name}${i>unlocked?'ï¼ˆæœªè§£é”ï¼‰':''}</option>`).join('');
  if(+el.level.value>unlocked||el.level.value==='') el.level.value=String(unlocked);
  el.sUnlock.textContent='L'+(unlocked+1);
}
function rint(a,b){return (Math.random()*(b-a+1)|0)+a}
function makeWord(lv){let n=rint(lv.min,lv.max),s='';for(let i=0;i<n;i++)s+=lv.chars[rint(0,lv.chars.length-1)];return s}

function resetState(){
  const li=+el.level.value||0,lv=levels[li],tt=+el.time.value;
  state={running:false,over:false,li,lv,time:tt,last:performance.now(),spawnAt:0,score:0,combo:0,life:5,typed:'',enemies:[],shots:[],explodes:[]};
  syncUI();
  el.result.style.display='none';
}
function syncUI(){
  el.sLevel.textContent='L'+(state.li+1);
  el.sGoal.textContent=state.lv.goal;
  el.sScore.textContent=state.score;
  el.sCombo.textContent=state.combo;
  el.sLife.textContent=state.life;
  el.sTime.textContent=Math.ceil(state.time);
  el.sUnlock.textContent='L'+(unlocked+1);
  el.typed.innerHTML=state.typed?`<b>${state.typed}</b>`:'<em>è¾“å…¥å­—æ¯ä»¥ç„å‡†ï¼šå®Œæ•´æ‰“å‡ºç›®æ ‡è¯ä¼šå‘å°„å¹¶å‡»ä¸­</em>';
}

function spawnEnemy(){
  const w=makeWord(state.lv);
  const x=rint(90,cv.width-90), y=-20;
  state.enemies.push({x,y,r:26+Math.min(14,w.length*2),word:w,v:state.lv.speed + Math.random()*18,hit:false});
}
function drawPlayer(){
  const x=cv.width/2,y=cv.height-48;
  ctx.fillStyle='#78d2ff';
  ctx.beginPath();ctx.moveTo(x,y-16);ctx.lineTo(x-18,y+16);ctx.lineTo(x+18,y+16);ctx.closePath();ctx.fill();
}
function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  for(let i=0;i<80;i++){ctx.fillStyle='rgba(180,210,255,.12)';ctx.fillRect((i*131)%cv.width,(i*73+40)%cv.height,2,2)}

  state.enemies.forEach(e=>{
    ctx.fillStyle='#203a79';ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#4e7cff';ctx.lineWidth=2;ctx.stroke();
    ctx.fillStyle='#f2f6ff';ctx.font='bold 20px monospace';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(e.word,e.x,e.y+1);

    if(state.typed && e.word.startsWith(state.typed)){
      ctx.strokeStyle='rgba(97,235,175,.9)';ctx.lineWidth=3;ctx.strokeRect(e.x-e.r-4,e.y-e.r-4,e.r*2+8,e.r*2+8);
    }
  });

  state.shots.forEach(s=>{ctx.strokeStyle='#ffe082';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(s.x1,s.y1);ctx.lineTo(s.x2,s.y2);ctx.stroke();});
  state.explodes.forEach(ex=>{ctx.strokeStyle=`rgba(255,160,100,${ex.a})`;ctx.lineWidth=3;ctx.beginPath();ctx.arc(ex.x,ex.y,ex.r,0,Math.PI*2);ctx.stroke();});
  drawPlayer();
}

function fireAt(enemy){
  const px=cv.width/2,py=cv.height-48;
  state.shots.push({x1:px,y1:py,x2:enemy.x,y2:enemy.y,t:0.08});
  state.explodes.push({x:enemy.x,y:enemy.y,r:10,a:1});
}

function update(dt){
  if(!state.running||state.over) return;
  state.time-=dt;
  if(state.time<=0){ state.time=0; return gameEnd(false); }

  state.spawnAt-=dt*1000;
  if(state.spawnAt<=0){ spawnEnemy(); state.spawnAt=state.lv.spawn; }

  for(const e of state.enemies) e.y += e.v*dt;
  let miss=0;
  state.enemies = state.enemies.filter(e=>{ if(e.y-e.r>cv.height){miss++; return false;} return true;});
  if(miss){ state.life-=miss; state.combo=0; }
  if(state.life<=0){ state.life=0; return gameEnd(false); }

  state.shots=state.shots.filter(s=>(s.t-=dt)>0);
  state.explodes=state.explodes.filter(ex=>{ex.r+=140*dt; ex.a-=2*dt; return ex.a>0});

  if(state.score>=state.lv.goal) return gameEnd(true);
  syncUI();
}

function gameEnd(pass){
  state.running=false; state.over=true; syncUI();
  if(pass){
    if(unlocked<state.li+1 && state.li<levels.length-1){unlocked=state.li+1;localStorage.setItem('typingShooterUnlocked',unlocked);setupLevelOptions();}
    el.result.style.display='block';
    el.result.innerHTML=`ğŸ‰ è¿‡å…³æˆåŠŸï¼<b>${levels[state.li].name}</b><br>å¾—åˆ† <b>${state.score}</b> / ${state.lv.goal}ï¼Œè¿å‡»æœ€é«˜è¡¨ç°å¾ˆæ£’ã€‚${state.li<levels.length-1?`<br>å·²è§£é”ï¼š<b>${levels[Math.min(unlocked,levels.length-1)].name}</b>`:'<br>ğŸŒŸ å·²å®Œæˆå…¨éƒ¨å…³å¡ï¼'}`;
  }else{
    el.result.style.display='block';
    el.result.innerHTML=`â¹ï¸ æœ¬å±€ç»“æŸï¼šå¾—åˆ† <b>${state.score}</b> / ${state.lv.goal}ï¼Œç”Ÿå‘½å·²è€—å°½æˆ–æ—¶é—´åˆ°ã€‚<br>å†æ¥ä¸€å±€ï¼Œä½ ç¦»è¿‡å…³å¾ˆè¿‘äº†ï¼`;
  }
}

function tryHitByInput(){
  const typed=state.typed;
  if(!typed) return;
  // exact match: choose nearest bottom threat first
  const idx = state.enemies
    .map((e,i)=>({e,i}))
    .filter(x=>x.e.word===typed)
    .sort((a,b)=>b.e.y-a.e.y)[0]?.i;
  if(idx===undefined) return;

  const e=state.enemies[idx];
  fireAt(e);
  state.enemies.splice(idx,1);
  state.combo += 1;
  state.score += typed.length + Math.min(10,state.combo);
  state.typed='';
  syncUI();
}

function onKey(e){
  if(!state.running||state.over) return;
  if(e.key==='Backspace'){ state.typed=state.typed.slice(0,-1); syncUI(); e.preventDefault(); return; }
  if(e.key==='Escape'){ state.typed=''; syncUI(); return; }
  if(/^[a-zA-Z]$/.test(e.key)){
    state.typed += e.key.toLowerCase();
    // if no word starts with typed, break combo softly and clear
    const hasPrefix = state.enemies.some(en=>en.word.startsWith(state.typed));
    if(!hasPrefix){ state.combo=0; state.typed=''; }
    tryHitByInput();
    syncUI();
  }
}

function loop(ts){
  const dt=Math.min(0.033,(ts-state.last)/1000); state.last=ts;
  update(dt); draw(); requestAnimationFrame(loop);
}

el.start.onclick=()=>{ resetState(); state.running=true; state.spawnAt=500; el.result.style.display='none'; };
el.reset.onclick=()=>resetState();
el.level.onchange=()=>{ if(!state?.running) resetState(); };
el.time.onchange=()=>{ if(!state?.running) resetState(); };
document.addEventListener('keydown',onKey);

setupLevelOptions();
resetState();
requestAnimationFrame(loop);
</script>
</body>
</html>