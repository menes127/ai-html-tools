<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AMD 高管 Form 4 监控面板</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif; margin: 20px; color: #111; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    .card { border:1px solid #ddd; border-radius:10px; padding:12px; min-width:180px; }
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:14px 0; }
    input, select, button { padding:8px 10px; border:1px solid #ccc; border-radius:8px; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; vertical-align:top; }
    th { background:#fafafa; position:sticky; top:0; }
    .pill { border-radius:999px; padding:2px 8px; font-size:12px; display:inline-block; }
    .buy { background:#e8f7ea; color:#0b7a2a; }
    .sell { background:#fdecec; color:#b42318; }
    .muted { color:#666; font-size:12px; }
    .warn { color:#9a6700; }
    a { color:#0059c9; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .chart-table { width:100%; border-collapse:collapse; font-size:13px; }
    .chart-table th,.chart-table td { border-bottom:1px solid #eee; padding:6px 8px; text-align:right; }
    .chart-table th:first-child,.chart-table td:first-child { text-align:left; }
    .code-hint { margin-top:8px; font-size:12px; color:#555; line-height:1.6; }
    .code-tag { display:inline-block; padding:1px 6px; border-radius:999px; border:1px solid #ddd; margin-right:4px; font-size:11px; }
  </style>
</head>
<body>
  <h2>AMD 高管买卖监控（SEC Form 4）</h2>
  <div class="muted" id="meta">加载中...</div>

  <div class="row" id="summary"></div>

  <div class="filters">
    <label>年份：
      <select id="yearFilter"></select>
    </label>
    <label>姓名：<input id="nameFilter" placeholder="例如 Lisa" /></label>
    <label>代码：
      <select id="codeFilter">
        <option value="">全部</option>
        <option value="P">P（公开市场买入）</option>
        <option value="S">S（公开市场卖出）</option>
        <option value="M">M（期权行权）</option>
      </select>
    </label>
    <label><input type="checkbox" id="onlySignal" /> 仅显示强/中信号（P/S）</label>
    <button id="refreshBtn">刷新</button>
  </div>

  <div class="card" style="margin-bottom:14px;">
    <div style="font-weight:600;margin-bottom:8px;">高管股票操作趋势图（买入/卖出/授予/其他）</div>
    <div class="filters" style="margin:8px 0;">
      <label>维度：
        <select id="chartGranularity">
          <option value="year">按年</option>
          <option value="month">按月（当前年份）</option>
        </select>
      </label>
      <label>高管：
        <select id="chartInsider"></select>
      </label>
    </div>
    <div id="chartMeta" class="muted" style="margin-bottom:6px;"></div>
    <div id="chartRows"></div>
    <div class="code-hint">
      <span class="code-tag">A</span>Acquired（获得，常见授予/归属）
      <span class="code-tag">G</span>Gift（赠与）
      <span class="code-tag">M</span>Option Exercise（期权行权）
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>交易日</th>
        <th>姓名 / 职位</th>
        <th>代码</th>
        <th>股数</th>
        <th>价格</th>
        <th>方向</th>
        <th>交易后持仓</th>
        <th>10b5-1</th>
        <th>备注</th>
        <th>SEC</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    const dataBase = './data';
    let indexData = null;
    let yearRows = [];
    const yearCache = {};

    const fmtNum = (n) => (n === null || n === undefined || Number.isNaN(n)) ? '-' : Number(n).toLocaleString();

    function signalClass(code) {
      if (code === 'P') return 'pill buy';
      if (code === 'S') return 'pill sell';
      return 'pill';
    }

    function signalText(code) {
      if (code === 'P') return '买入';
      if (code === 'S') return '卖出';
      return '其他';
    }

    function renderSummary(summary) {
      const el = document.getElementById('summary');
      const codes = Object.entries(summary.codes || {}).map(([k,v]) => `${k}: ${v}`).join(' / ') || '-';
      el.innerHTML = `
        <div class="card"><div class="muted">总交易条数（当前年份）</div><div><b>${summary.total_transactions ?? 0}</b></div></div>
        <div class="card"><div class="muted">最近交易日</div><div><b>${summary.latest_transaction_date ?? '-'}</b></div></div>
        <div class="card"><div class="muted">代码分布</div><div><b>${codes}</b></div></div>
      `;
    }

    function applyFilters() {
      const name = document.getElementById('nameFilter').value.trim().toLowerCase();
      const code = document.getElementById('codeFilter').value;
      const onlySignal = document.getElementById('onlySignal').checked;

      return yearRows.filter(r => {
        if (name && !(r.insider_name || '').toLowerCase().includes(name)) return false;
        if (code && r.code !== code) return false;
        if (onlySignal && !['P','S'].includes(r.code)) return false;
        return true;
      });
    }

    function renderTable() {
      const body = document.getElementById('tbody');
      const filtered = applyFilters();

      body.innerHTML = filtered.map(r => {
        const footnote = (r.footnote_hint || '').slice(0, 120);
        return `
          <tr>
            <td>${r.transaction_date || '-'}</td>
            <td>
              <div><b>${r.insider_name || '-'}</b></div>
              <div class="muted">${r.insider_title || (r.relationship || []).join(', ') || '-'}</div>
            </td>
            <td><span class="${signalClass(r.code)}">${r.code || '-'}</span></td>
            <td>${fmtNum(r.shares)}</td>
            <td>${r.price ? ('$' + Number(r.price).toFixed(2)) : '-'}</td>
            <td>${signalText(r.code)}</td>
            <td>${fmtNum(r.shares_owned_after)}</td>
            <td>${r.is_10b5_1 ? '是' : '否'}</td>
            <td class="${r.is_10b5_1 ? 'warn' : ''}">${footnote || '-'}</td>
            <td><a href="${r.filing_url}" target="_blank" rel="noopener">查看</a></td>
          </tr>
        `;
      }).join('');
    }

    async function loadIndex() {
      const res = await fetch(`${dataBase}/index.json`, { cache: 'no-store' });
      if (!res.ok) throw new Error('无法读取 data/index.json');
      indexData = await res.json();

      const yearSel = document.getElementById('yearFilter');
      const years = indexData.years || [];
      yearSel.innerHTML = years.map(y => `<option value="${y.year}">${y.year} (${y.count})</option>`).join('');
      if (indexData.default_year) yearSel.value = String(indexData.default_year);

      document.getElementById('meta').textContent =
        `生成时间(UTC): ${indexData.generated_at || '-'} | 扫描文件: ${indexData.filings_scanned || 0} | 回看天数: ${indexData.lookback_days || 0}`;
    }

    async function loadYear(year) {
      if (yearCache[year]) {
        yearRows = yearCache[year].transactions || [];
        renderSummary(yearCache[year].summary || {});
        renderTable();
        renderChart();
        return;
      }
      const res = await fetch(`${dataBase}/${year}.json`, { cache: 'no-store' });
      if (!res.ok) throw new Error(`无法读取 ${year}.json`);
      const data = await res.json();
      yearCache[year] = data;
      yearRows = data.transactions || [];
      renderSummary(data.summary || {});
      renderTable();
      updateChartInsiderOptions();
      renderChart();
    }

    function updateChartInsiderOptions() {
      const sel = document.getElementById('chartInsider');
      const names = Array.from(new Set(yearRows.map(r => r.insider_name).filter(Boolean))).sort();
      sel.innerHTML = `<option value="">全部高管</option>` + names.map(n => `<option value="${n}">${n}</option>`).join('');
    }

    async function ensureAllYearsLoaded() {
      const years = (indexData?.years || []).map(y => String(y.year));
      for (const y of years) {
        if (!yearCache[y]) {
          const res = await fetch(`${dataBase}/${y}.json`, { cache: 'no-store' });
          if (res.ok) yearCache[y] = await res.json();
        }
      }
    }

    function aggregate(rows, keyFn, insider) {
      const map = {};
      for (const r of rows) {
        if (insider && r.insider_name !== insider) continue;
        const k = keyFn(r);
        if (!map[k]) map[k] = { buy: 0, sell: 0, grant: 0, other: 0 };
        const v = Number(r.shares || 0);

        if (r.code === 'P') map[k].buy += v;
        else if (r.code === 'S') map[k].sell += v;
        else if (['A','G','M'].includes(r.code)) map[k].grant += v;
        else map[k].other += v;
      }
      return map;
    }

    function renderChartRows(series) {
      const holder = document.getElementById('chartRows');
      const items = Object.entries(series);
      if (!items.length) {
        holder.innerHTML = `<div class="muted">暂无可绘制数据</div>`;
        return;
      }

      const rows = items.map(([label, v]) => {
        const total = (v.buy || 0) + (v.sell || 0) + (v.grant || 0) + (v.other || 0);
        return `
          <tr>
            <td>${label}</td>
            <td>${fmtNum(Math.round(v.buy || 0))}</td>
            <td>${fmtNum(Math.round(v.sell || 0))}</td>
            <td>${fmtNum(Math.round(v.grant || 0))}</td>
            <td>${fmtNum(Math.round(v.other || 0))}</td>
            <td><b>${fmtNum(Math.round(total))}</b></td>
          </tr>
        `;
      }).join('');

      holder.innerHTML = `
        <table class="chart-table">
          <thead>
            <tr>
              <th>时间</th>
              <th>买入 (P)</th>
              <th>卖出 (S)</th>
              <th>授予/行权 (A/G/M)</th>
              <th>其他代码</th>
              <th>合计</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    async function renderChart() {
      const granularity = document.getElementById('chartGranularity').value;
      const insider = document.getElementById('chartInsider').value;
      const currentYear = document.getElementById('yearFilter').value;
      const meta = document.getElementById('chartMeta');

      if (granularity === 'year') {
        await ensureAllYearsLoaded();
        const allRows = Object.values(yearCache).flatMap(d => d.transactions || []);
        const series = aggregate(allRows, (r) => (r.transaction_date || '').slice(0,4), insider);
        const ordered = Object.fromEntries(Object.entries(series).sort((a,b) => a[0].localeCompare(b[0])));
        meta.textContent = `按年统计（单位：股数；含买入/卖出/授予(A/G/M)/其他）${insider ? `｜高管：${insider}` : '｜高管：全部'}`;
        renderChartRows(ordered);
      } else {
        const series = aggregate(yearRows, (r) => (r.transaction_date || '').slice(0,7), insider);
        const ordered = Object.fromEntries(Object.entries(series).sort((a,b) => a[0].localeCompare(b[0])));
        meta.textContent = `按月统计（${currentYear}，单位：股数；含买入/卖出/授予(A/G/M)/其他）${insider ? `｜高管：${insider}` : '｜高管：全部'}`;
        renderChartRows(ordered);
      }
    }

    async function loadData() {
      await loadIndex();
      const year = document.getElementById('yearFilter').value;
      await loadYear(year);
      updateChartInsiderOptions();
      renderChart();
    }

    ['nameFilter','codeFilter','onlySignal'].forEach(id => {
      document.getElementById(id).addEventListener('input', renderTable);
      document.getElementById(id).addEventListener('change', renderTable);
    });

    document.getElementById('yearFilter').addEventListener('change', async (e) => {
      await loadYear(e.target.value);
      updateChartInsiderOptions();
      renderChart();
    });

    document.getElementById('chartGranularity').addEventListener('change', renderChart);
    document.getElementById('chartInsider').addEventListener('change', renderChart);
    document.getElementById('refreshBtn').addEventListener('click', loadData);

    loadData().catch(err => {
      document.getElementById('meta').textContent = err.message + '（先运行脚本生成 data/index.json 与 data/YYYY.json）';
    });
  </script>
</body>
</html>
