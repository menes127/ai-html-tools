<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AMD 高管 Form 4 监控面板</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif; margin: 20px; color: #111; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    .card { border:1px solid #ddd; border-radius:10px; padding:12px; min-width:180px; }
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:14px 0; }
    input, select, button { padding:8px 10px; border:1px solid #ccc; border-radius:8px; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; vertical-align:top; }
    th { background:#fafafa; position:sticky; top:0; }
    .pill { border-radius:999px; padding:2px 8px; font-size:12px; display:inline-block; }
    .buy { background:#e8f7ea; color:#0b7a2a; }
    .sell { background:#fdecec; color:#b42318; }
    .muted { color:#666; font-size:12px; }
    .warn { color:#9a6700; }
    a { color:#0059c9; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .chart-table { width:100%; border-collapse:collapse; font-size:13px; }
    .chart-table th,.chart-table td { border-bottom:1px solid #eee; padding:6px 8px; text-align:right; }
    .chart-table th:first-child,.chart-table td:first-child { text-align:left; }
    .code-hint { margin-top:8px; font-size:12px; color:#555; line-height:1.6; }
    .code-tag { display:inline-block; padding:1px 6px; border-radius:999px; border:1px solid #ddd; margin-right:4px; font-size:11px; }
  </style>
</head>
<body>
  <h2>AMD 高管买卖监控（SEC Form 4）</h2>
  <div class="muted" id="meta">加载中...</div>

  <div class="row" id="marketSignal"></div>
  <div class="row" id="summary"></div>

  <div class="filters">
    <label>年份：
      <select id="yearFilter"></select>
    </label>
    <label>姓名：<input id="nameFilter" placeholder="例如 Lisa" /></label>
    <label>代码：
      <select id="codeFilter">
        <option value="">全部</option>
        <option value="P">P（公开市场买入）</option>
        <option value="S">S（公开市场卖出）</option>
        <option value="M">M（期权行权）</option>
      </select>
    </label>
    <label><input type="checkbox" id="onlySignal" /> 仅显示强/中信号（P/S）</label>
    <label>10b5-1：
      <select id="b5Filter">
        <option value="">全部</option>
        <option value="yes">仅10b5-1</option>
        <option value="no">排除10b5-1</option>
      </select>
    </label>
    <button id="refreshBtn">刷新</button>
  </div>

  <div class="card" style="margin-bottom:14px;">
    <div style="font-weight:600;margin-bottom:8px;">高管股票操作趋势图（买入/卖出/授予/其他）</div>
    <div class="filters" style="margin:8px 0;">
      <label>维度：
        <select id="chartGranularity">
          <option value="year">按年</option>
          <option value="month">按月（当前年份）</option>
        </select>
      </label>
      <label>高管：
        <select id="chartInsider"></select>
      </label>
    </div>
    <div id="chartMeta" class="muted" style="margin-bottom:6px;"></div>
    <div id="chartRows"></div>
    <div class="code-hint">
      <span class="code-tag">A</span>Acquired（获得，常见授予/归属）
      <span class="code-tag">G</span>Gift（赠与）
      <span class="code-tag">M</span>Option Exercise（期权行权）
      <br/>* 期末持仓：按该时间段内最后一笔交易记录的 `sharesOwnedFollowingTransaction` 近似展示。
    </div>
    <details style="margin-top:10px;">
      <summary style="cursor:pointer;font-weight:600;">交易代码说明（Form 4）</summary>
      <div class="muted" style="margin-top:8px;line-height:1.7;">
        <b>P</b> 公开市场买入；<b>S</b> 公开市场卖出；<b>M</b> 期权行权；<b>A</b> 获得/授予；<b>G</b> 赠与；<b>F</b> 税务预扣相关处置。<br/>
        说明：S 不一定看空，需结合 10b5-1 与 footnote 判断。
      </div>
    </details>
  </div>

  <table>
    <thead>
      <tr>
        <th>交易日</th>
        <th>姓名 / 职位</th>
        <th>代码</th>
        <th>股数</th>
        <th>价格</th>
        <th>方向</th>
        <th>交易后持仓</th>
        <th>10b5-1</th>
        <th>备注</th>
        <th>SEC</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    const dataBase = './data';
    let indexData = null;
    let yearRows = [];
    const yearCache = {};

    const fmtNum = (n) => (n === null || n === undefined || Number.isNaN(n)) ? '-' : Number(n).toLocaleString();

    function signalClass(code) {
      if (code === 'P') return 'pill buy';
      if (code === 'S') return 'pill sell';
      return 'pill';
    }

    function signalText(code) {
      if (code === 'P') return '买入';
      if (code === 'S') return '卖出';
      return '其他';
    }

    function calcAmounts(rows) {
      let buyAmt = 0, sellAmt = 0;
      for (const r of rows || []) {
        const shares = Number(r.shares || 0);
        const price = Number(r.price || 0);
        if (r.code === 'P') buyAmt += shares * price;
        if (r.code === 'S') sellAmt += shares * price;
      }
      return { buyAmt, sellAmt, net: sellAmt - buyAmt };
    }

    function renderSummary(summary, rows, allTimeNet) {
      const el = document.getElementById('summary');
      const codes = Object.entries(summary.codes || {}).map(([k,v]) => `${k}: ${v}`).join(' / ') || '-';
      const amt = calcAmounts(rows);
      el.innerHTML = `
        <div class="card"><div class="muted">总交易条数（当前年份）</div><div><b>${summary.total_transactions ?? 0}</b></div></div>
        <div class="card"><div class="muted">最近交易日</div><div><b>${summary.latest_transaction_date ?? '-'}</b></div></div>
        <div class="card"><div class="muted">年度买入金额(P)</div><div><b>$${fmtNum(Math.round(amt.buyAmt))}</b></div></div>
        <div class="card"><div class="muted">年度卖出金额(S)</div><div><b>$${fmtNum(Math.round(amt.sellAmt))}</b></div></div>
        <div class="card"><div class="muted">全时段净额(卖-买)</div><div><b>$${fmtNum(Math.round(allTimeNet || 0))}</b></div></div>
        <div class="card"><div class="muted">代码分布</div><div><b>${codes}</b></div></div>
      `;
    }

    function applyFilters() {
      const name = document.getElementById('nameFilter').value.trim().toLowerCase();
      const code = document.getElementById('codeFilter').value;
      const onlySignal = document.getElementById('onlySignal').checked;
      const b5 = document.getElementById('b5Filter').value;

      return yearRows.filter(r => {
        if (name && !(r.insider_name || '').toLowerCase().includes(name)) return false;
        if (code && r.code !== code) return false;
        if (onlySignal && !['P','S'].includes(r.code)) return false;
        if (b5 === 'yes' && !r.is_10b5_1) return false;
        if (b5 === 'no' && r.is_10b5_1) return false;
        return true;
      });
    }

    function renderTable() {
      const body = document.getElementById('tbody');
      const filtered = applyFilters();

      body.innerHTML = filtered.map(r => {
        const footnote = (r.footnote_hint || '').slice(0, 120);
        return `
          <tr>
            <td>${r.transaction_date || '-'}</td>
            <td>
              <div><b>${r.insider_name || '-'}</b></div>
              <div class="muted">${r.insider_title || (r.relationship || []).join(', ') || '-'}</div>
            </td>
            <td><span class="${signalClass(r.code)}">${r.code || '-'}</span></td>
            <td>${fmtNum(r.shares)}</td>
            <td>${r.price ? ('$' + Number(r.price).toFixed(2)) : '-'}</td>
            <td>${signalText(r.code)}</td>
            <td>${fmtNum(r.shares_owned_after)}</td>
            <td>${r.is_10b5_1 ? '是' : '否'}</td>
            <td class="${r.is_10b5_1 ? 'warn' : ''}">${footnote || '-'}</td>
            <td><a href="${r.filing_url}" target="_blank" rel="noopener">查看</a></td>
          </tr>
        `;
      }).join('');
    }

    function sma(arr, n) {
      if (arr.length < n) return null;
      const s = arr.slice(arr.length - n).reduce((a,b)=>a+b,0);
      return s / n;
    }

    function rsi(closes, period = 14) {
      if (closes.length < period + 1) return null;
      let gains = 0, losses = 0;
      for (let i = closes.length - period; i < closes.length; i++) {
        const diff = closes[i] - closes[i-1];
        if (diff >= 0) gains += diff; else losses += -diff;
      }
      if (losses === 0) return 100;
      const rs = gains / losses;
      return 100 - (100 / (1 + rs));
    }

    async function renderMarketSignal() {
      const el = document.getElementById('marketSignal');
      try {
        const res = await fetch('https://query1.finance.yahoo.com/v8/finance/chart/AMD?range=6mo&interval=1d');
        const data = await res.json();
        const q = data?.chart?.result?.[0]?.indicators?.quote?.[0];
        const closes = (q?.close || []).filter(v => typeof v === 'number');
        if (!closes.length) throw new Error('no price');
        const last = closes[closes.length - 1];
        const s20 = sma(closes, 20);
        const s60 = sma(closes, 60);
        const rv = rsi(closes, 14);

        let trend = '中性';
        let action = '观望';
        if (s20 && s60 && rv !== null) {
          if (last > s20 && s20 > s60 && rv >= 50 && rv <= 72) { trend = '强势'; action = '偏买入'; }
          else if (last < s20 && s20 < s60 && rv <= 48) { trend = '弱势'; action = '偏卖出/减仓'; }
        }

        el.innerHTML = `
          <div class="card"><div class="muted">AMD 价格强弱</div><div><b>${trend}</b></div></div>
          <div class="card"><div class="muted">AI 信号（技术面）</div><div><b>${action}</b></div></div>
          <div class="card"><div class="muted">现价 / SMA20 / SMA60</div><div><b>$${last.toFixed(2)} / $${s20?.toFixed(2) || '-'} / $${s60?.toFixed(2) || '-'}</b></div></div>
          <div class="card"><div class="muted">RSI(14)</div><div><b>${rv?.toFixed(1) || '-'}</b></div></div>
        `;
      } catch (e) {
        el.innerHTML = `<div class="card"><div class="muted">AMD 价格强弱</div><div><b>暂不可用</b></div><div class="muted">价格源获取失败，可稍后刷新</div></div>`;
      }
    }

    async function loadIndex() {
      const res = await fetch(`${dataBase}/index.json`, { cache: 'no-store' });
      if (!res.ok) throw new Error('无法读取 data/index.json');
      indexData = await res.json();

      const yearSel = document.getElementById('yearFilter');
      const years = indexData.years || [];
      yearSel.innerHTML = years.map(y => `<option value="${y.year}">${y.year} (${y.count})</option>`).join('');
      if (indexData.default_year) yearSel.value = String(indexData.default_year);

      document.getElementById('meta').textContent =
        `生成时间(UTC): ${indexData.generated_at || '-'} | 扫描文件: ${indexData.filings_scanned || 0} | 回看天数: ${indexData.lookback_days || 0}`;
    }

    function calcAllTimeNet() {
      const allRows = Object.values(yearCache).flatMap(d => d.transactions || []);
      return calcAmounts(allRows).net;
    }

    async function loadYear(year) {
      if (!yearCache[year]) {
        const res = await fetch(`${dataBase}/${year}.json`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`无法读取 ${year}.json`);
        yearCache[year] = await res.json();
      }
      yearRows = yearCache[year].transactions || [];
      renderSummary(yearCache[year].summary || {}, yearRows, calcAllTimeNet());
      renderTable();
      updateChartInsiderOptions();
      renderChart();
    }

    function updateChartInsiderOptions() {
      const sel = document.getElementById('chartInsider');
      const names = Array.from(new Set(yearRows.map(r => r.insider_name).filter(Boolean))).sort();
      sel.innerHTML = `<option value="">全部高管</option>` + names.map(n => `<option value="${n}">${n}</option>`).join('');
    }

    async function ensureAllYearsLoaded() {
      const years = (indexData?.years || []).map(y => String(y.year));
      for (const y of years) {
        if (!yearCache[y]) {
          const res = await fetch(`${dataBase}/${y}.json`, { cache: 'no-store' });
          if (res.ok) yearCache[y] = await res.json();
        }
      }
    }

    function aggregate(rows, keyFn, insider) {
      const map = {};
      for (const r of rows) {
        if (insider && r.insider_name !== insider) continue;
        const k = keyFn(r);
        if (!map[k]) map[k] = { buy: 0, sell: 0, grant: 0, other: 0, sellAmount: 0, latestDate: '', endHolding: null };
        const v = Number(r.shares || 0);

        if (r.code === 'P') map[k].buy += v;
        else if (r.code === 'S') {
          map[k].sell += v;
          map[k].sellAmount += v * Number(r.price || 0);
        }
        else if (['A','G','M'].includes(r.code)) map[k].grant += v;
        else map[k].other += v;

        const d = r.transaction_date || '';
        if (d && d >= map[k].latestDate) {
          map[k].latestDate = d;
          map[k].endHolding = r.shares_owned_after ?? map[k].endHolding;
        }
      }
      return map;
    }

    function renderChartRows(series) {
      const holder = document.getElementById('chartRows');
      const items = Object.entries(series);
      if (!items.length) {
        holder.innerHTML = `<div class="muted">暂无可绘制数据</div>`;
        return;
      }

      const rows = items.map(([label, v]) => {
        const total = (v.buy || 0) + (v.sell || 0) + (v.grant || 0) + (v.other || 0);
        const avgSellPrice = (v.sell && v.sell > 0) ? (v.sellAmount / v.sell) : 0;
        return `
          <tr>
            <td>${label}</td>
            <td>${fmtNum(Math.round(v.buy || 0))}</td>
            <td>${fmtNum(Math.round(v.sell || 0))}</td>
            <td>${avgSellPrice > 0 ? ('$' + avgSellPrice.toFixed(2)) : '-'}</td>
            <td>${v.sellAmount > 0 ? ('$' + fmtNum(Math.round(v.sellAmount))) : '-'}</td>
            <td>${fmtNum(Math.round(v.grant || 0))}</td>
            <td>${fmtNum(Math.round(v.other || 0))}</td>
            <td>${v.endHolding !== null && v.endHolding !== undefined ? fmtNum(Math.round(Number(v.endHolding))) : '-'}</td>
            <td><b>${fmtNum(Math.round(total))}</b></td>
          </tr>
        `;
      }).join('');

      holder.innerHTML = `
        <table class="chart-table">
          <thead>
            <tr>
              <th>时间</th>
              <th>买入 (P)</th>
              <th>卖出 (S)</th>
              <th>卖出均价</th>
              <th>卖出金额</th>
              <th>授予/行权 (A/G/M)</th>
              <th>其他代码</th>
              <th>期末持仓*</th>
              <th>合计</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    async function renderChart() {
      const granularity = document.getElementById('chartGranularity').value;
      const insider = document.getElementById('chartInsider').value;
      const currentYear = document.getElementById('yearFilter').value;
      const meta = document.getElementById('chartMeta');

      if (granularity === 'year') {
        await ensureAllYearsLoaded();
        const allRows = Object.values(yearCache).flatMap(d => d.transactions || []);
        const series = aggregate(allRows, (r) => (r.transaction_date || '').slice(0,4), insider);
        const ordered = Object.fromEntries(Object.entries(series).sort((a,b) => a[0].localeCompare(b[0])));
        meta.textContent = `按年统计（单位：股数；含买入/卖出/授予(A/G/M)/其他）${insider ? `｜高管：${insider}` : '｜高管：全部'}`;
        renderChartRows(ordered);
      } else {
        const series = aggregate(yearRows, (r) => (r.transaction_date || '').slice(0,7), insider);
        const ordered = Object.fromEntries(Object.entries(series).sort((a,b) => a[0].localeCompare(b[0])));
        meta.textContent = `按月统计（${currentYear}，单位：股数；含买入/卖出/授予(A/G/M)/其他）${insider ? `｜高管：${insider}` : '｜高管：全部'}`;
        renderChartRows(ordered);
      }
    }

    async function loadData() {
      await loadIndex();
      await renderMarketSignal();
      await ensureAllYearsLoaded();
      const year = document.getElementById('yearFilter').value;
      await loadYear(year);
      updateChartInsiderOptions();
      renderChart();
    }

    ['nameFilter','codeFilter','onlySignal','b5Filter'].forEach(id => {
      document.getElementById(id).addEventListener('input', renderTable);
      document.getElementById(id).addEventListener('change', renderTable);
    });

    document.getElementById('yearFilter').addEventListener('change', async (e) => {
      await loadYear(e.target.value);
      updateChartInsiderOptions();
      renderChart();
    });

    document.getElementById('chartGranularity').addEventListener('change', renderChart);
    document.getElementById('chartInsider').addEventListener('change', renderChart);
    document.getElementById('refreshBtn').addEventListener('click', loadData);

    loadData().catch(err => {
      document.getElementById('meta').textContent = err.message + '（先运行脚本生成 data/index.json 与 data/YYYY.json）';
    });
  </script>
</body>
</html>
